{"ts":1377176747911,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"<?php\n\n/**\n * Description of orm\n * Base ORM class for extending\n * @author Ervin\n */\nclass orm {\n    \n    /**\n     * Variables\n     */\n    \n    /**\n     * fields array holds row data\n     * @var type \n     */\n    protected $fields=array();\n    /**\n     * keyField holds name of field wich is primary key (defined in extended ORM class)\n     * @var type \n     */\n    protected $keyField;\n    /**\n     * key holds primary key for target table\n     * @var type \n     */\n    protected $key;\n    /**\n     * loaded holds ORM status 1 if data is loaded form DB, 0 if its empty, 2 if data is desynchronized(before saving)\n     * @var type \n     */\n    protected $loaded=0;\n    /**\n     * table holds name of the table in question (defined in extended ORM class)\n     * @var type \n     */\n    protected $table;\n    /**\n     * schema holds data used for table creation (defined in extended ORM class)\n     * @var type \n     */\n    protected $schema=array();\n    \n    \n    \n    /**\n     * Construct\n     * @param type $key\n     */\n    public function __construct($key=NULL) {\n        $this->key=$key;\n        if($key!=NULL){\n            $this->load();\n        }\n    }\n    \n    /**\n     * Methods\n     */\n    \n    /**\n     * loads data from DB\n     * @param type $key\n     * @return \\orm\n     */\n    public function load($key='none'){\n        if('none'!==$key){\n            $this->key=$key;\n        }\n        if(empty($this->keyField)){\n            $logStatement='ORM Load failed in '.get_class($this).' Primary Key is empty!';\n            log::writeLogEntry($logStatement);\n            return $this;\n        }\n        $sql=\"SELECT * FROM $this->table\";\n        $result=db::query($sql);\n        $this->fields=db::fetch_array($result);\n        if($this->fields==FALSE){\n            $logStatement='ORM Load failed in '.get_class($this).' SELECT failed!';\n            log::writeLogEntry($logStatement);\n            $this->unload();\n            return $this;\n        }\n        $this->loadExtraWork();\n        $this->loaded=1;\n        \n    return $this;\n    }\n    \n    /**\n     * Gets field value\n     * @param type $what\n     * @return type\n     */\n    public function get($what) {\n        return $this->fields[$what];\n    }\n    \n    /**\n     * Sets Data to variable representing that DB colum for row loaded in ORM not trigering actual save to FB by default\n     * @param type $what\n     * @param type $update\n     * @return \\orm\n     */\n    public function set($what, $val, $update=FALSE){\n        $val=db::makeSafe($val);\n        $this->fields[$what]=$val;\n        \n        if(1==$this->loaded or 2==$this->loaded){\n            $this->loaded=2;\n        }\n        else {\n            $this->loaded=3;\n        }\n        echo $this->state(TRUE);\n        \n        if($update){\n            $this->save();\n        }\n        \n        return $this;\n    }\n    \n    /**\n     * Returns state of ORM as int or as str(default is int)\n     * @param type $verbal\n     * @return string or int\n     */\n    public function state($verbal=FALSE){\n        if($verbal){\n            switch ($this->loaded){\n            case 0:\n                return 'Empty(unloaded)';\n                break;\n            case 1:\n                return 'Synchronized(loaded)';\n                break;\n            case 2:\n                return 'Desynchronized(loaded)';\n                break;\n            case 3:\n                return 'Desynchronized(New row data)';\n                break;\n            }\n        }\n        else {\n            return $this->loaded;\n        }\n    }\n    \n    /**\n     * Unloads data and resets ORM to not loaded state\n     * @return \\orm\n     */\n    public function unload() {\n        \n        $this->fields=array();\n        $this->loaded=0;\n        unset($this->key);\n        \n        return $this;\n    }\n    \n    /**\n     * Deletes Row to wich it tied to from table first param states if deleteExtraWork method shuld be caled for user specified clean up, second param if true will unload data from ORM otherwise you still have soft backup loaded in orm class\n     * @param type $hasChildsOrParrents\n     * @param type $andUnload\n     * @return \\orm\n     */\n    public function delete($hasChildsOrParrents=FALSE,$andUnload=FALSE) {\n        $sql=\"DELETE FROM $this->table WHERE $this->keyField=$this->key LIMIT 1;\";\n        db::query($sql);\n        $this->loaded=3;\n        if($hasChildsOrParrents){\n            $this->deleteExtraWork();\n        }\n        \n        if($andUnload){\n            $this->unload();\n        }\n        \n        return $this;\n    }\n\n    /**\n     * saves current data from array to DB\n     */\n    public function save(){\n        echo '<br>SAVING<br>';\n        echo $this->fields['msg'];\n        if($this->loaded==1 OR $this->loaded==2){\n            if($this->loaded==1){\n                //zapis do logu\n            }\n            else {\n                $sql=\"UPDATE $this->table SET \";\n                foreach ($this->fields as $key => $value) {\n                    $sql.=\" $key='$value',\";\n                }\n                $sql=substr_replace($sql ,\"\",-1);\n                $sql.=\"WHERE $this->key=some_value\";\n            }\n        }\n        else {\n            $keys='';\n            $vals='';\n            foreach ($this->fields as $key => $value) {\n                $keys.=$key.',';\n                $vals.='\\''.$value.'\\''.',';\n            }\n            $keys=substr_replace($keys ,\"\",-1);\n            $vals=substr_replace($vals ,\"\",-1);\n            $sql=\"INSERT INTO $this->table ($keys) VALUES($vals)\";\n        }\n        \n        echo '<br>'.$sql.'<br>';\n        \n        db::query($sql);\n        $this->loaded=1;\n    }\n    \n    /**\n     * checks for table existance returns true if table is present if first param is true it will create specified table if table dont exist\n     * @param type $ifNotCreateIt\n     * @return boolean\n     */\n    public function checkForTable($ifNotCreateIt=FALSE) {\n        $result=db::query(\"SHOW TABLES LIKE '$this->table'\");\n        \n           $prep=db::fetch_array($result);\n           if($prep==FALSE){\n               if($ifNotCreateIt){\n                   $this->create();\n               }\n               else {\n                   return FALSE;\n               }\n           }\n           else {\n               return true;\n           }  \n    }\n    \n    /**\n     * Creates table acording to schema not overwriting existing one unles first param is true\n     * @param type $force\n     */\n    protected function create($force=FALSE) {\n        if($force){$sqlForcePart=\"\";}else{$sqlForcePart=\"IF NOT EXISTS\";}\n        \n        $sql=\"CREATE TABLE $sqlForcePart `$this->table` (\";\n        foreach ($this->schema as $key => $value) {\n            switch ($this->schema[$key]['type']){\n                case 'int':\n                    $typeAndLimit='int('.$this->schema[$key]['limit'].')';\n                    break;\n                case 'varchar':\n                    $typeAndLimit='varchar('.$this->schema[$key]['limit'].')';\n                    break;\n                case 'text':\n                    $typeAndLimit='text';\n                    break;\n                default:\n                    $typeAndLimit=$this->schema[$key]['type'].'('.$this->schema[$key]['limit'].')';\n                    break;\n            }\n            \n            if ($this->schema[$key]['null']==0){$null='NOT NULL';}else{$null='';}\n            if ($this->schema[$key]['key']==1){$auto='AUTO_INCREMENT';$primary=$this->schema[$key]['name'];}else{$auto='';}\n            \n            $sql.='`'.$this->schema[$key]['name'].'` '.$typeAndLimit.' '.$null.' '.$auto.',';\n        }\n        \n        $sql.='PRIMARY KEY (`'.$primary.'`)';\n        $sql.=') ENGINE=MyISAM DEFAULT CHARSET=utf8 COLLATE=utf8_czech_ci AUTO_INCREMENT=1 ;';\n        \n        db::query($sql);\n    }\n\n    /**\n     * place for special script that shuld be executed after selecting data\n     */\n    protected function loadExtraWork(){\n        \n    }\n    \n    /**\n     * place for special script that shuld be executed before saving data\n     */\n    protected function saveExtraWork(){\n        \n    }\n    \n    /**\n     * place for special script that is executed when delete is caled whit first param true\n     */\n    protected function deleteExtraWork() {\n        \n    }\n}\n\n//end of file orm.php\n"]],"start1":0,"start2":0,"length1":0,"length2":8266}]],"length":8266}
